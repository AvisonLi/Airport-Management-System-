<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/airport-system.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>

    <div class="checkin-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-plane-departure"></i> Online Check-in</h1>
            <p>Complete your check-in in 4 easy steps</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step-indicator-1">
                <div class="step-circle">1</div>
                <div class="step-title">Verify Booking</div>
            </div>
            <div class="step" id="step-indicator-2">
                <div class="step-circle">2</div>
                <div class="step-title">Passenger Info</div>
            </div>
            <div class="step" id="step-indicator-3">
                <div class="step-circle">3</div>
                <div class="step-title">Select Seat</div>
            </div>
            <div class="step" id="step-indicator-4">
                <div class="step-circle">4</div>
                <div class="step-title">Boarding Pass</div>
            </div>
        </div>

        <!-- Step 1: Verify Booking -->
        <div class="step-content active" id="step-1">
            <h2><i class="fas fa-search"></i> Find Your Booking</h2>
            <p class="text-muted mb-4">Please enter your booking reference and full name to begin check-in</p>

            <div class="alert alert-info d-flex align-items-center" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <div>
                    <strong>Check-in opens 24 hours before departure (Optional earlier is acceptable)</strong><br>
                    Please have your booking reference and passport ready
                </div>
            </div>

            <form id="booking-form" class="passenger-form-grid">
                <div class="form-group">
                    <label for="booking-ref" class="form-label">
                        <i class="fas fa-ticket-alt"></i> Booking Reference
                    </label>
                    <input type="text" 
                           id="booking-ref" 
                           name="bookingRef" 
                           class="form-control" 
                           placeholder="e.g., ABC123" 
                           required>
                </div>

                <div class="form-group">
                    <label for="full-name" class="form-label">
                        <i class="fas fa-user"></i> Full Name
                    </label>
                    <input type="text" 
                           id="full-name" 
                           name="fullName" 
                           class="form-control" 
                           placeholder="As shown on passport" 
                           required>
                </div>
            </form>

            <div class="action-buttons d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='/passenger'">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </button>
                <button type="button" class="btn btn-primary" onclick="verifyBooking()">
                    Continue <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 2: Passenger Information -->
        <div class="step-content" id="step-2">
            <!-- Flight Info Card -->
            <div class="flight-info-card">
                <div class="flight-route">
                    <div>
                        <div class="airport-code" id="origin-code">TPE</div>
                        <div class="flight-detail-label">Taipei Taoyuan</div>
                    </div>
                    <div class="flight-arrow">
                        <i class="fas fa-plane"></i>
                    </div>
                    <div>
                        <div class="airport-code" id="destination-code">NRT</div>
                        <div class="flight-detail-label">Tokyo Narita</div>
                    </div>
                </div>

                <div class="flight-details">
                    <div class="flight-detail-item">
                        <i class="fas fa-plane-departure"></i>
                        <div>
                            <div class="flight-detail-label">Flight Number</div>
                            <div class="flight-detail-value" id="flight-number">CI100</div>
                        </div>
                    </div>
                    <div class="flight-detail-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                            <div class="flight-detail-label">Date</div>
                            <div class="flight-detail-value" id="flight-date">Dec 15, 2025</div>
                        </div>
                    </div>
                    <div class="flight-detail-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <div class="flight-detail-label">Departure</div>
                            <div class="flight-detail-value" id="departure-time">09:00</div>
                        </div>
                    </div>
                    <div class="flight-detail-item">
                        <i class="fas fa-user"></i>
                        <div>
                            <div class="flight-detail-label">Passenger</div>
                            <div class="flight-detail-value" id="passenger-name">John Doe</div>
                        </div>
                    </div>
                </div>
            </div>

            <h2><i class="fas fa-id-card"></i> Confirm Passenger Information</h2>
            <p class="text-muted mb-4">Please verify your details match your travel documents</p>

            <form id="passenger-info-form" class="passenger-form-grid">
                <div class="form-group">
                    <label for="first-name" class="form-label">
                        <i class="fas fa-user"></i> First Name
                    </label>
                    <input type="text" 
                           id="first-name" 
                           name="firstName" 
                           class="form-control" 
                           required>
                </div>

                <div class="form-group">
                    <label for="full-name-confirm" class="form-label">
                        <i class="fas fa-user"></i> Full Name
                    </label>
                    <input type="text" 
                           id="full-name-confirm" 
                           name="fullNameConfirm" 
                           class="form-control" 
                           required>
                </div>

                <div class="form-group">
                    <label for="passport" class="form-label">
                        <i class="fas fa-passport"></i> Passport Number
                    </label>
                    <input type="text" 
                           id="passport" 
                           name="passport" 
                           class="form-control" 
                           placeholder="A12345678" 
                           required>
                </div>

                <div class="form-group">
                    <label for="nationality" class="form-label">
                        <i class="fas fa-flag"></i> Nationality
                    </label>
                    <select id="nationality" name="nationality" class="form-select" required>
                        <option value="">Select nationality</option>
                        <option value="HK">HKSAR</option>
                        <option value="US">United States</option>
                        <option value="JP">Japan</option>
                        <option value="CN">China</option>
                        <option value="KR">South Korea</option>
                        <option value="GB">United Kingdom</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dob" class="form-label">
                        <i class="fas fa-birthday-cake"></i> Date of Birth
                    </label>
                    <input type="date" 
                           id="dob" 
                           name="dob" 
                           class="form-control" 
                           required>
                </div>

                <div class="form-group">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope"></i> Email
                    </label>
                    <input type="email" 
                           id="email" 
                           name="email" 
                           class="form-control" 
                           placeholder="your.email@example.com" 
                           required>
                </div>
            </form>

            <div class="action-buttons d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary" onclick="previousStep(1)">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                    Continue <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Step 3: Seat Selection -->
        <div class="step-content" id="step-3">
            <h2><i class="fas fa-couch"></i> Select Your Seat</h2>
            <p class="text-muted mb-4">Choose your preferred seat from the available options</p>

            <!-- Seat Legend -->
            <div class="seat-map-container">
                <div class="seat-legend">
                    <div class="legend-item">
                        <div class="legend-box available"></div>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box occupied"></div>
                        <span>Occupied</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box selected"></div>
                        <span>Selected</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box premium"></div>
                        <span>Premium (+$50)</span>
                    </div>
                </div>

                <!-- Seat Map -->
                <div class="seat-map" id="seat-map">
                    <!-- Premium Class -->
                    <div class="seat-section">
                        <div class="seat-section-title">Premium Class</div>
                        <div class="seat-row">
                            <div class="seat-row-label">1</div>
                            <div class="seat premium" data-seat="1A" onclick="selectSeat('1A')">1A</div>
                            <div class="seat premium" data-seat="1B" onclick="selectSeat('1B')">1B</div>
                            <div class="seat aisle"></div>
                            <div class="seat premium occupied" data-seat="1C">1C</div>
                            <div class="seat premium" data-seat="1D" onclick="selectSeat('1D')">1D</div>
                        </div>
                        <div class="seat-row">
                            <div class="seat-row-label">2</div>
                            <div class="seat premium" data-seat="2A" onclick="selectSeat('2A')">2A</div>
                            <div class="seat premium occupied" data-seat="2B">2B</div>
                            <div class="seat aisle"></div>
                            <div class="seat premium" data-seat="2C" onclick="selectSeat('2C')">2C</div>
                            <div class="seat premium" data-seat="2D" onclick="selectSeat('2D')">2D</div>
                        </div>
                    </div>

                    <!-- Economy Class -->
                    <div class="seat-section">
                        <div class="seat-section-title">Economy Class</div>
                        <div class="seat-row">
                            <div class="seat-row-label">3</div>
                            <div class="seat available" data-seat="3A" onclick="selectSeat('3A')">3A</div>
                            <div class="seat available" data-seat="3B" onclick="selectSeat('3B')">3B</div>
                            <div class="seat available" data-seat="3C" onclick="selectSeat('3C')">3C</div>
                            <div class="seat aisle"></div>
                            <div class="seat occupied" data-seat="3D">3D</div>
                            <div class="seat available" data-seat="3E" onclick="selectSeat('3E')">3E</div>
                            <div class="seat available" data-seat="3F" onclick="selectSeat('3F')">3F</div>
                        </div>
                        <div class="seat-row">
                            <div class="seat-row-label">4</div>
                            <div class="seat available" data-seat="4A" onclick="selectSeat('4A')">4A</div>
                            <div class="seat occupied" data-seat="4B">4B</div>
                            <div class="seat available" data-seat="4C" onclick="selectSeat('4C')">4C</div>
                            <div class="seat aisle"></div>
                            <div class="seat available" data-seat="4D" onclick="selectSeat('4D')">4D</div>
                            <div class="seat available" data-seat="4E" onclick="selectSeat('4E')">4E</div>
                            <div class="seat occupied" data-seat="4F">4F</div>
                        </div>
                        <div class="seat-row">
                            <div class="seat-row-label">5</div>
                            <div class="seat available" data-seat="5A" onclick="selectSeat('5A')">5A</div>
                            <div class="seat available" data-seat="5B" onclick="selectSeat('5B')">5B</div>
                            <div class="seat available" data-seat="5C" onclick="selectSeat('5C')">5C</div>
                            <div class="seat aisle"></div>
                            <div class="seat available" data-seat="5D" onclick="selectSeat('5D')">5D</div>
                            <div class="seat available" data-seat="5E" onclick="selectSeat('5E')">5E</div>
                            <div class="seat available" data-seat="5F" onclick="selectSeat('5F')">5F</div>
                        </div>
                        <div class="seat-row">
                            <div class="seat-row-label">6</div>
                            <div class="seat available" data-seat="6A" onclick="selectSeat('6A')">6A</div>
                            <div class="seat available" data-seat="6B" onclick="selectSeat('6B')">6B</div>
                            <div class="seat available" data-seat="6C" onclick="selectSeat('6C')">6C</div>
                            <div class="seat aisle"></div>
                            <div class="seat available" data-seat="6D" onclick="selectSeat('6D')">6D</div>
                            <div class="seat available" data-seat="6E" onclick="selectSeat('6E')">6E</div>
                            <div class="seat available" data-seat="6F" onclick="selectSeat('6F')">6F</div>
                        </div>
                    </div>
                </div>

                <!-- Selected Seat Info -->
                <div class="seat-selected-info card mt-4 p-3" id="seat-selected-info" style="display: none;">
                    <h4 class="card-title"><i class="fas fa-check-circle text-success"></i> Seat Selected</h4>
                    <div class="card-body p-0">
                        <p class="mb-2"><strong>Seat Number:</strong> <span id="selected-seat-number" class="badge bg-primary"></span></p>
                        <p class="mb-0"><strong>Additional Fee:</strong> $<span id="selected-seat-fee">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Baggage Options -->
            <h3 class="mt-4 mb-3"><i class="fas fa-suitcase"></i> Add Baggage (Optional)</h3>
<div class="row row-cols-1 row-cols-md-3 g-3">
    <div class="col">
        <div class="baggage-option card h-100" onclick="selectBaggage('none', this)">
            <div class="card-body p-3 text-center">
                <input type="radio" name="baggage" value="none" class="form-check-input position-absolute top-0 end-0 m-2" checked>
                <div class="mb-2">
                    <i class="fas fa-ban fa-lg text-muted"></i>
                </div>
                <h6 class="card-title mb-1">No Extra Baggage</h6>
                <p class="card-text small text-muted mb-2">Carry-on only (7kg)</p>
                <div class="h5 mb-0 text-success">$0</div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="baggage-option card h-100" onclick="selectBaggage('20kg', this)">
            <div class="card-body p-3 text-center">
                <input type="radio" name="baggage" value="20kg" class="form-check-input position-absolute top-0 end-0 m-2">
                <div class="mb-2">
                    <i class="fas fa-suitcase fa-lg text-primary"></i>
                </div>
                <h6 class="card-title mb-1">20kg Checked Bag</h6>
                <p class="card-text small text-muted mb-2">Standard checked baggage</p>
                <div class="h5 mb-0 text-primary">$30</div>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="baggage-option card h-100" onclick="selectBaggage('32kg', this)">
            <div class="card-body p-3 text-center">
                <input type="radio" name="baggage" value="32kg" class="form-check-input position-absolute top-0 end-0 m-2">
                <div class="mb-2">
                    <i class="fas fa-suitcase-rolling fa-lg text-warning"></i>
                </div>
                <h6 class="card-title mb-1">32kg Checked Bag</h6>
                <p class="card-text small text-muted mb-2">Extra baggage allowance</p>
                <div class="h5 mb-0 text-warning">$50</div>
            </div>
        </div>
    </div>
</div>
            <div class="action-buttons d-flex justify-content-between mt-5">
                <button type="button" class="btn btn-outline-secondary" onclick="previousStep(2)">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button type="button" class="btn btn-success" id="btn-complete-checkin" onclick="completeCheckin()" disabled>
                    Complete Check-in <i class="fas fa-check"></i>
                </button>
            </div>
        </div>

        <!-- Step 4: Boarding Pass -->
        <div class="step-content" id="step-4">
            <div class="alert alert-success d-flex align-items-center" role="alert">
                <i class="fas fa-check-circle me-2 fa-lg"></i>
                <div>
                    <strong>Check-in Successful!</strong><br>
                    Your boarding pass is ready. Please save or print it for boarding.
                </div>
            </div>

            <!-- Boarding Pass -->
            <div class="boarding-pass">
                <div class="boarding-pass-content">
                    <div class="boarding-pass-header">
                        <div class="airline-logo"><i class="fas fa-plane"></i></div>
                        <div class="boarding-pass-title">BOARDING PASS</div>
                    </div>

                    <div class="bp-route">
                        <div class="bp-airport" id="bp-origin">TPE</div>
                        <div class="bp-arrow"><i class="fas fa-arrow-right"></i></div>
                        <div class="bp-airport" id="bp-destination">NRT</div>
                    </div>

                    <div class="boarding-pass-body">
                        <div class="bp-field">
                            <div class="bp-label">Passenger</div>
                            <div class="bp-value" id="bp-passenger">JOHN DOE</div>
                        </div>
                        <div class="bp-field">
                            <div class="bp-label">Flight</div>
                            <div class="bp-value" id="bp-flight">CI100</div>
                        </div>
                        <div class="bp-field">
                            <div class="bp-label">Date</div>
                            <div class="bp-value" id="bp-date">15 DEC</div>
                        </div>
                        <div class="bp-field">
                            <div class="bp-label">Departure</div>
                            <div class="bp-value" id="bp-time">09:00</div>
                        </div>
                        <div class="bp-field">
                            <div class="bp-label">Gate</div>
                            <div class="bp-value" id="bp-gate">B12</div>
                        </div>
                        <div class="bp-field">
                            <div class="bp-label">Seat</div>
                            <div class="bp-value" id="bp-seat">12A</div>
                        </div>
                        <div class="bp-field">
                            <div class="bp-label">Boarding</div>
                            <div class="bp-value" id="bp-boarding">08:30</div>
                        </div>
                        <div class="bp-field">
                            <div class="bp-label">Class</div>
                            <div class="bp-value" id="bp-class">Economy</div>
                        </div>
                    </div>

                    <div class="barcode" id="bp-barcode">
                        || ABC123456789 ||
                    </div>
                </div>
            </div>

            <div class="action-buttons d-flex justify-content-center gap-3 mt-4">
                <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Boarding Pass
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadBoardingPass()">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button type="button" class="btn btn-success" onclick="window.location.href='/passenger'">
                    <i class="fas fa-home"></i> Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    let currentStep = 1;
    let selectedSeat = null;
    let selectedBaggage = 'none';
    let bookingData = null;

    // Step Navigation Functions
    function nextStep(step) {
        // Validate current step before proceeding
        if (!validateStep(currentStep)) {
            return;
        }

        // Hide current step
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');
        document.getElementById(`step-indicator-${currentStep}`).classList.add('completed');

        // Show next step
        currentStep = step;
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.getElementById(`step-indicator-${currentStep}`).classList.add('active');

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function previousStep(step) {
        // Hide current step
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');

        // Show previous step
        currentStep = step;
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.getElementById(`step-indicator-${currentStep}`).classList.add('active');
        document.getElementById(`step-indicator-${currentStep}`).classList.remove('completed');

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep(step) {
        switch(step) {
            case 1:
                const bookingRef = document.getElementById('booking-ref').value;
                const fullName = document.getElementById('full-name').value;
                if (!bookingRef || !fullName) {
                    showBootstrapAlert('Please fill in all required fields', 'warning');
                    return false;
                }
                return true;
            case 2:
                const form = document.getElementById('passenger-info-form');
                if (!form.checkValidity()) {
                    showBootstrapAlert('Please fill in all required fields correctly', 'warning');
                    return false;
                }
                return true;
            case 3:
                if (!selectedSeat) {
                    showBootstrapAlert('Please select a seat', 'warning');
                    return false;
                }
                return true;
            default:
                return true;
        }
    }

    // VIEW BOARDING PASS FUNCTION
    window.viewBoardingPass = function(bookingRef) {
        if (!bookingRef || bookingRef.trim() === '') {
            showBootstrapAlert('Booking reference is required', 'danger');
            return;
        }
        
        const cleanBookingRef = bookingRef.trim().toUpperCase();
        const url = `/passenger/boarding-pass/${encodeURIComponent(cleanBookingRef)}`;
        
        const button = event ? event.target : null;
        if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            button.disabled = true;
            
            setTimeout(() => {
                window.location.href = url;
            }, 500);
        } else {
            window.location.href = url;
        }
    };

    // Booking Verification Function
async function verifyBooking() {
    const bookingRef = document.getElementById('booking-ref').value.trim().toUpperCase();
    const fullName = document.getElementById('full-name').value.trim();

    if (!bookingRef || !fullName) {
        showBootstrapAlert('Please fill in all fields', 'danger');
        return;
    }

    // Show loading state - FIXED: Get the button that triggered this function
    let verifyBtn;
    if (event && event.target) {
        verifyBtn = event.target;
    } else {
        // Fallback: try to find the continue button in step 1
        const step1Buttons = document.querySelectorAll('#step-1 .btn-primary');
        verifyBtn = step1Buttons.length > 0 ? step1Buttons[step1Buttons.length - 1] : null;
    }
    
    if (!verifyBtn) {
        // If we can't find the button, proceed without loading state
        verifyBtn = { disabled: false, innerHTML: '' };
    }
    
    const originalText = verifyBtn.innerHTML;
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

    try {
        const response = await fetch('/api/verify-booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                bookingRef: bookingRef, 
                fullName: fullName 
            })
        });

        const data = await response.json();
        
        console.log('Verification response:', data);
        
        // Reset button
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = originalText;
        
        if (data.success && data.booking) {
            bookingData = data.booking;
            console.log('Booking data:', bookingData);
            
            // Populate flight information
            populateFlightInfo(bookingData);
            
            // Pre-fill passenger information
            prefillPassengerInfo(bookingData);
            
            // Move to next step
            nextStep(2);
            
            showBootstrapAlert('Booking verified successfully!', 'success');
        } else {
            showBootstrapAlert(data.message || 'Booking verification failed', 'danger');
        }
    } catch (error) {
        console.error('Error verifying booking:', error);
        
        // Reset button
        if (verifyBtn) {
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = originalText;
        }
        
        showBootstrapAlert('An error occurred. Please try again.', 'danger');
    }
}
    // Populate Flight Information
function populateFlightInfo(booking) {
    console.log('Populating flight info with:', booking);
    
    // Set origin and destination
    document.getElementById('origin-code').textContent = booking.origin || booking.departure_airport || 'N/A';
    document.getElementById('destination-code').textContent = booking.destination || booking.arrival_airport || 'N/A';
    document.getElementById('flight-number').textContent = booking.flight_code || booking.flight_number || 'N/A';
    
    // Format and set date
    const flightDate = booking.flight_date ? new Date(booking.flight_date) : new Date();
    document.getElementById('flight-date').textContent = flightDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
    
    // Set departure time
    document.getElementById('departure-time').textContent = booking.departure_time || '09:00';
    
    // Set passenger name
    document.getElementById('passenger-name').textContent = booking.passenger_name || 'Passenger';
    
    // Also update boarding pass section
    document.getElementById('bp-origin').textContent = booking.origin || booking.departure_airport || 'TPE';
    document.getElementById('bp-destination').textContent = booking.destination || booking.arrival_airport || 'NRT';
    document.getElementById('bp-flight').textContent = booking.flight_code || booking.flight_number || 'CI100';
    
    // Format date for boarding pass (e.g., "15 DEC")
    const bpDate = flightDate.toLocaleDateString('en-US', {
        day: 'numeric',
        month: 'short'
    }).toUpperCase();
    document.getElementById('bp-date').textContent = bpDate;
}
    // Complete Check-in Function
    async function completeCheckin() {
        if (!selectedSeat) {
            showBootstrapAlert('Please select a seat', 'warning');
            return;
        }
        
        const bookingRef = document.getElementById('booking-ref').value.trim().toUpperCase();
        const fullName = document.getElementById('full-name').value.trim();
        const passport = document.getElementById('passport') ? document.getElementById('passport').value : '';
        
        if (!bookingRef || !fullName) {
            showBootstrapAlert('Please verify your booking first', 'warning');
            return;
        }
        
        // Determine seat type and fee
        const seatElement = document.querySelector(`.seat[data-seat="${selectedSeat}"]`);
        const isPremiumSeat = seatElement ? seatElement.classList.contains('premium') : false;
        const seatFee = isPremiumSeat ? 50 : 0;
        const cabinClass = isPremiumSeat ? 'Premium' : 'Economy';
        
        // Determine baggage
        let baggageWeight = 0;
        let baggageFee = 0;
        let baggageType = 'carry-on';
        
        switch(selectedBaggage) {
            case '20kg':
                baggageWeight = 20;
                baggageFee = 30;
                baggageType = 'checked';
                break;
            case '32kg':
                baggageWeight = 32;
                baggageFee = 50;
                baggageType = 'checked';
                break;
            default:
                baggageWeight = 7;
                baggageFee = 0;
                baggageType = 'carry-on';
        }
        
        // Get passenger info from form
        const passengerName = document.getElementById('full-name-confirm').value;
        const firstName = document.getElementById('first-name').value;
        const nationality = document.getElementById('nationality').value;
        const dob = document.getElementById('dob').value;
        const email = document.getElementById('email').value;
        
        // Show loading state
        const button = document.getElementById('btn-complete-checkin');
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        try {
            const response = await fetch('/api/complete-checkin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    passenger: {
                        name: passengerName,
                        firstName: firstName,
                        bookingRef: bookingRef,
                        passport: passport,
                        nationality: nationality,
                        dateOfBirth: dob,
                        email: email
                    },
                    seat: {
                        seat: selectedSeat,
                        cabin: cabinClass,
                        fee: seatFee
                    },
                    baggage: {
                        type: baggageType,
                        weight: baggageWeight,
                        fee: baggageFee
                    }
                })
            });
            
            const data = await response.json();
            
            // Reset button
            button.disabled = false;
            button.innerHTML = originalText;
            
            if (data.success && data.boardingPass) {
                console.log('Boarding pass data received:', data.boardingPass);
                populateBoardingPass(data.boardingPass);
                nextStep(4);
                showBootstrapAlert('Check-in completed successfully!', 'success');
            } else {
                showBootstrapAlert(data.message || 'Check-in failed. Please try again.', 'danger');
            }
        } catch (error) {
            console.error('Error completing check-in:', error);
            button.disabled = false;
            button.innerHTML = originalText;
            showBootstrapAlert('An error occurred during check-in. Please try again.', 'danger');
        }
    }

    // Populate Boarding Pass
    function populateBoardingPass(bp) {
        console.log('Populating boarding pass with:', bp);
        
        // Basic flight info
        document.getElementById('bp-origin').textContent = bp.origin || 'TPE';
        document.getElementById('bp-destination').textContent = bp.destination || 'NRT';
        document.getElementById('bp-passenger').textContent = bp.passenger ? bp.passenger.toUpperCase() : 'PASSENGER';
        document.getElementById('bp-flight').textContent = bp.flight || bp.flightNumber || 'CI100';
        
        // Format date for boarding pass (short format: 15 DEC)
        if (bp.date) {
            const date = new Date(bp.date);
            const shortDate = date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short'
            }).toUpperCase();
            document.getElementById('bp-date').textContent = shortDate;
        }
        
        // Time and gate
        document.getElementById('bp-time').textContent = bp.time || bp.departureTime || '09:00';
        document.getElementById('bp-gate').textContent = bp.gate || 'B12';
        
        // Seat
        let seatNumber = '12A';
        if (typeof bp.seat === 'string') {
            seatNumber = bp.seat;
        } else if (bp.seat && typeof bp.seat === 'object') {
            seatNumber = bp.seat.seat || bp.seat.number || '12A';
        }
        document.getElementById('bp-seat').textContent = seatNumber;
        
        // Boarding time (30 minutes before departure by default)
        document.getElementById('bp-boarding').textContent = bp.boardingTime || '08:30';
        
        // Cabin class
        let cabinClass = 'Economy';
        if (bp.cabinClass) {
            cabinClass = bp.cabinClass;
        } else if (bp.seat && bp.seat.cabin) {
            cabinClass = bp.seat.cabin;
        } else if (bp.cabin) {
            cabinClass = bp.cabin;
        }
        document.getElementById('bp-class').textContent = cabinClass;
        
        // Barcode - use booking reference or generate one
        document.getElementById('bp-barcode').textContent = bp.barcode ? `|| ${bp.barcode} ||` : `|| ${bookingRef || 'ABC123456789'} ||`;
    }

    // Seat Selection Functions
    function selectSeat(seatNumber) {
        // Remove selected class from all seats
        document.querySelectorAll('.seat').forEach(seat => {
            seat.classList.remove('selected');
        });
        
        // Add selected class to clicked seat
        const seatElement = document.querySelector(`.seat[data-seat="${seatNumber}"]`);
        if (seatElement) {
            seatElement.classList.add('selected');
            selectedSeat = seatNumber;
            
            // Show seat selection info
            document.getElementById('seat-selected-info').style.display = 'block';
            document.getElementById('selected-seat-number').textContent = seatNumber;
            
            // Calculate seat fee
            let seatFee = 0;
            if (seatElement.classList.contains('premium')) {
                seatFee = 50;
            }
            document.getElementById('selected-seat-fee').textContent = seatFee;
            
            // Enable complete check-in button
            document.getElementById('btn-complete-checkin').disabled = false;
        }
    }

    // Baggage Selection Functions
    function selectBaggage(baggageType) {
        selectedBaggage = baggageType;
        
        // Remove selected class from all baggage options
        document.querySelectorAll('.baggage-option').forEach(option => {
            option.classList.remove('selected');
            option.classList.remove('border-primary');
        });
        
        // Add selected class to clicked option
        const baggageOption = event.currentTarget || event.target.closest('.baggage-option');
        if (baggageOption) {
            baggageOption.classList.add('selected');
            baggageOption.classList.add('border-primary');
            
            // Also check the radio button
            const radioButton = baggageOption.querySelector('input[type="radio"]');
            if (radioButton) {
                radioButton.checked = true;
            }
        }
    }

    // Bootstrap Alert Helper Function
    function showBootstrapAlert(message, type = 'info') {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.bootstrap-toast-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create toast container if not exists
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.className = `toast bootstrap-toast-alert`;
        toast.id = toastId;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        const alertClass = {
            'success': 'bg-success text-white',
            'danger': 'bg-danger text-white',
            'warning': 'bg-warning text-dark',
            'info': 'bg-info text-white'
        }[type] || 'bg-info text-white';
        
        toast.innerHTML = `
            <div class="toast-header ${alertClass}">
                <strong class="me-auto">
                    <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    ${type.charAt(0).toUpperCase() + type.slice(1)}
                </strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 5000
        });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', function () {
            toast.remove();
        });
    }

    // Pre-fill Passenger Information
function prefillPassengerInfo(booking) {
    console.log('Prefilling passenger info with:', booking);
    
    const passengerName = booking.passenger_name || '';
    const nameParts = passengerName.split(' ');
    
    // Set first name (first part)
    if (nameParts.length > 0) {
        document.getElementById('first-name').value = nameParts[0];
    }
    
    // Set full name confirm
    document.getElementById('full-name-confirm').value = passengerName;
    
    // Also try to fill other fields if available in booking data
    if (booking.passport) {
        document.getElementById('passport').value = booking.passport;
    }
    if (booking.email) {
        document.getElementById('email').value = booking.email;
    }
    if (booking.date_of_birth) {
        document.getElementById('dob').value = booking.date_of_birth;
    }
    if (booking.nationality) {
        document.getElementById('nationality').value = booking.nationality;
    }
    
    // Also update the airport labels if available
    const airportLabels = document.querySelectorAll('.flight-detail-label');
    if (booking.origin_name) {
        // The second flight-detail-label is the origin name
        if (airportLabels[1]) {
            airportLabels[1].textContent = booking.origin_name;
        }
    }
    if (booking.destination_name) {
        // The fourth flight-detail-label is the destination name
        if (airportLabels[3]) {
            airportLabels[3].textContent = booking.destination_name;
        }
    }
}

    // Download Boarding Pass Function
    function downloadBoardingPass() {
        const passenger = document.getElementById('bp-passenger').textContent;
        const flight = document.getElementById('bp-flight').textContent;
        const seat = document.getElementById('bp-seat').textContent;
        const gate = document.getElementById('bp-gate').textContent;
        const date = document.getElementById('bp-date').textContent;
        const time = document.getElementById('bp-time').textContent;
        
        const content = `BOARDING PASS\n\nPassenger: ${passenger}\nFlight: ${flight}\nDate: ${date}\nTime: ${time}\nGate: ${gate}\nSeat: ${seat}\n\nThank you for flying with HKAP Airlines!`;
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BoardingPass_${flight}_${passenger}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showBootstrapAlert('Boarding pass downloaded successfully!', 'success');
    }

    // Initialize Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Set default baggage selection
        const defaultBaggage = document.querySelector('.baggage-option input[value="none"]');
        if (defaultBaggage) {
            const baggageOption = defaultBaggage.closest('.baggage-option');
            baggageOption.classList.add('selected');
            baggageOption.classList.add('border-primary');
        }
        
        // Add click handlers to seats
        document.querySelectorAll('.seat:not(.occupied):not(.aisle)').forEach(seat => {
            seat.addEventListener('click', function() {
                selectSeat(this.dataset.seat);
            });
        });
        
        // Add click handlers to baggage options
        document.querySelectorAll('.baggage-option').forEach(option => {
            option.addEventListener('click', function() {
                const value = this.querySelector('input[type="radio"]').value;
                selectBaggage(value);
            });
        });
        
        // Add form validation styles
        document.querySelectorAll('form input, form select').forEach(element => {
            element.addEventListener('blur', function() {
                if (this.checkValidity()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });
    });

    // Make functions globally accessible
    window.selectSeat = selectSeat;
    window.selectBaggage = selectBaggage;
    window.completeCheckin = completeCheckin;
    window.verifyBooking = verifyBooking;
    window.nextStep = nextStep;
    window.previousStep = previousStep;
    window.downloadBoardingPass = downloadBoardingPass;
    window.showBootstrapAlert = showBootstrapAlert;
</script>
</body>
</html>