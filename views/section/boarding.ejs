<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Boarding & Gates - Airport Management System' %></title>
    <link rel="stylesheet" href="/css/airport-system.css">
    <style>
        :root {
            --sidebar-width: 250px;
            --topbar-height: 70px;
            --padding-lg: 20px;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: var(--padding-lg);
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }

        /* Service Cards */
        .service-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #eef2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            color: #2c3e50;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.active { background-color: #10b981; }
        .status-indicator.warning { background-color: #f59e0b; }
        .status-indicator.error { background-color: #ef4444; }
        .status-indicator.inactive { background-color: #6b7280; }

        .card-content {
            padding: 20px;
        }

        /* Flight Selector */
        .flight-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .flight-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        /* Scanner Section */
        .scanner-section {
            display: grid;
            gap: 20px;
        }

        .scanner-input .input-group {
            display: flex;
            gap: 10px;
        }

        .scanner-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }

        /* Scan Result */
        .scan-result {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e5e7eb;
        }

        .passenger-info {
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .info-label {
            width: 100px;
            font-weight: 500;
            color: #4b5563;
        }

        .info-value {
            flex: 1;
            color: #1f2937;
        }

        .scan-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Flight Statistics */
        .flight-statistics {
            display: grid;
            gap: 20px;
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .flight-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .flight-subheader {
            display: flex;
            gap: 20px;
            color: #6b7280;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Passenger Counts */
        .passenger-counts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .count-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .count-item.business { border-left: 4px solid #8b5cf6; }
        .count-item.premium { border-left: 4px solid #3b82f6; }
        .count-item.economy { border-left: 4px solid #10b981; }

        .count-number {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .count-total {
            font-size: 18px;
            color: #6b7280;
        }

        .count-label {
            display: block;
            margin-top: 5px;
            color: #4b5563;
            font-size: 14px;
        }

        .count-percentage {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Progress Bar */
        .overall-progress {
            margin: 20px 0;
        }

        .progress-bar {
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #6b7280;
        }

        /* Boarding Actions */
        .boarding-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        /* Boarding Log */
        .boarding-log {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .log-header {
            display: grid;
            grid-template-columns: 120px 1fr 80px 100px 100px;
            padding: 15px 20px;
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .log-entries {
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            display: grid;
            grid-template-columns: 120px 1fr 80px 100px 100px;
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
            align-items: center;
        }

        .log-entry:hover {
            background: #f8fafc;
        }

        .log-entry .status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
        }

        .status.boarded { background: #d1fae5; color: #065f46; }
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.denied { background: #fee2e2; color: #991b1b; }
        .status.checked_in { background: #dbeafe; color: #1e40af; }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .passenger-counts {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }

            .flight-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .log-header,
            .log-entry {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .boarding-actions {
                flex-direction: column;
            }

            .scan-actions {
                flex-direction: column;
            }

            .scanner-input .input-group {
                flex-direction: column;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar" >
        <div class="logo" style="padding: 20px; border-bottom: 1px solid #334155;">
            <h2 style="margin: 0 0 5px 0; color: white;">‚úàÔ∏è AMS</h2>
            <span style="font-size: 12px; color: #cbd5e1;">AIRPORT MANAGEMENT SYSTEM</span>
        </div>
        
        <ul class="nav-menu" style="list-style: none; padding: 0; margin: 0;">
            <li class="nav-item">
                <a href="/section/passengers" style="display: flex; align-items: center; gap: 10px; padding: 15px 20px; color: #cbd5e1; text-decoration: none; border-left: 3px solid transparent;">
                    <i class="icon">üë§</i>
                    <span>Passenger Services</span>
                </a>
            </li>
            <li class="nav-item" data-section="boarding">
                <a href="/section/boarding">
                    <i class="icon">üö™</i>
                    <span>Boarding </span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/section/aircraft" style="display: flex; align-items: center; gap: 10px; padding: 15px 20px; color: #cbd5e1; text-decoration: none; border-left: 3px solid transparent;">
                    <i class="icon">üõ©</i>
                    <span>Aircraft & Crew</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/ground" style="display: flex; align-items: center; gap: 10px; padding: 15px 20px; color: #cbd5e1; text-decoration: none; border-left: 3px solid transparent;">
                    <i class="icon">üöõ</i>
                    <span>Ground Services</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/section/crew" style="display: flex; align-items: center; gap: 10px; padding: 15px 20px; color: #cbd5e1; text-decoration: none; border-left: 3px solid transparent;">
                    <i class="icon">üë∑</i>
                    <span>Crew Management</span>
                </a>
            </li>
             <li class="nav-item" data-section="gates">
                <a href="/section/gates">
                    <i class="icon">üïπÔ∏è </i>
                    <span>Gates</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content" style="margin-left: 250px; padding: 20px; width: calc(100% - 250px); box-sizing: border-box;">
        <!-- Top Bar -->
        <header class="top-bar" style="position: sticky; top: 0; z-index: 100; background: white; padding: 15px 0; border-bottom: 1px solid #e5e7eb; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div class="breadcrumb">
                <span id="current-section" style="font-size: 18px; font-weight: 600; color: #2c3e50;">Boarding & Gate Operations</span>
            </div>
            <div class="user-info" style="display: flex; align-items: center; gap: 15px;">
                <div class="user-details" style="text-align: right;">
                    <span class="user-name" style="display: block; font-weight: 600; color: #2c3e50;"><%= user?.full_name || 'Admin User' %></span>
                    <span class="user-role" style="font-size: 12px; color: #6b7280; text-transform: uppercase;"><%= user?.role || 'admin' %></span>
                </div>
                <div class="avatar" style="width: 40px; height: 40px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;"><%= user?.avatar || 'üë®‚Äçüíº' %></div>
                <a href="/logout" class="logout-btn" style="padding: 8px; border-radius: 6px; background: #f3f4f6; text-decoration: none;">
                    <span>üö™</span>
                </a>
            </div>
        </header>

        <!-- Boarding and Gate Operations Section -->
        <section id="boarding-section" style="max-width: 100%; overflow: hidden;">
            <h1 style="margin-bottom: 25px; color: #2c3e50;">Boarding & Gate Operations</h1>
            
            <!-- Flight Selection Area -->
            <div class="service-card">
                <div class="card-header">
                    <h3>‚úàÔ∏è Flight Selection</h3>
                    <div class="status-indicator active"></div>
                </div>
                <div class="card-content">
                    <div class="flight-selector">
                        <div>
                            <label for="flight-select">Select Flight:</label>
                            <select id="flight-select" class="form-select" onchange="loadFlightData()">
                                <option value="">-- Select Flight --</option>
                                <% if (flights && flights.length > 0) { %>
                                    <% flights.forEach(flight => { %>
                                        <option value="<%= flight.code %>" 
                                                data-gate="<%= flight.gate %>"
                                                data-departure="<%= flight.departure %>"
                                                data-route="<%= flight.route %>">
                                            <%= flight.code %> (<%= flight.route %>) - Gate <%= flight.gate %> - <%= flight.departure %>
                                        </option>
                                    <% }) %>
                                <% } else { %>
                                    <option value="HX101" data-gate="A15" data-departure="08:30" data-route="HKG ‚Üí TPE">HX101 (HKG ‚Üí TPE) - Gate A15 - 08:30</option>
                                    <option value="HX202" data-gate="B08" data-departure="14:20" data-route="HKG ‚Üí ICN">HX202 (HKG ‚Üí ICN) - Gate B08 - 14:20</option>
                                    <option value="HKAP001" data-gate="A12" data-departure="09:00" data-route="HKG ‚Üí TPE">HKAP001 (HKG ‚Üí TPE) - Gate A12 - 09:00</option>
                                <% } %>
                            </select>
                        </div>
                        
                        <div>
                            <label for="gate-select-boarding">Or Select Gate:</label>
                            <select id="gate-select-boarding" class="form-select" onchange="loadGateData()">
                                <option value="">-- Select Gate --</option>
                                <% if (gates && gates.length > 0) { %>
                                    <% gates.forEach(gate => { %>
                                        <option value="<%= gate %>">Gate <%= gate %></option>
                                    <% }) %>
                                <% } else { %>
                                    <option value="A12">Gate A12</option>
                                    <option value="A15">Gate A15</option>
                                    <option value="B08">Gate B08</option>
                                    <option value="B12">Gate B12</option>
                                <% } %>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Boarding Pass Scanner Area -->
            <div class="service-card">
                <div class="card-header">
                    <h3>üé´ Boarding Pass Scanner</h3>
                    <div class="status-indicator inactive" id="scanner-status"></div>
                </div>
                <div class="card-content">
                    <div class="scanner-section">
                        <div class="scanner-input">
                            <label for="boarding-pass-input">Scan/Enter Boarding Pass ID:</label>
                            <div class="input-group">
                                <input type="text" id="boarding-pass-input" placeholder="Enter boarding pass barcode or ID" onkeypress="if(event.key === 'Enter') scanBoardingPass()">
                                <button class="btn btn-primary" onclick="scanBoardingPass()">Scan</button>
                            </div>
                            <small style="color: #6b7280; margin-top: 5px; display: block;">Example: BP-BK-ALA-001 or BARCODE-1764684722934-1</small>
                        </div>
                        
                        <div class="scan-result" id="scan-result" style="display: none;">
                            <div class="passenger-info">
                                <h5 style="margin: 0 0 15px 0; color: #2c3e50;">Passenger Information:</h5>
                                <div class="info-row">
                                    <span class="info-label">Name:</span>
                                    <span class="info-value" id="scanned-name">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Seat:</span>
                                    <span class="info-value" id="scanned-seat">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Class:</span>
                                    <span class="info-value" id="scanned-class">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Flight:</span>
                                    <span class="info-value" id="scanned-flight">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Status:</span>
                                    <span class="info-value" id="scanned-status">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Passport:</span>
                                    <span class="info-value" id="scanned-passport">-</span>
                                </div>
                            </div>
                            <div class="scan-actions">
                                <button class="btn btn-success" onclick="confirmBoarding()">‚úÖ Confirm Boarding</button>
                                <button class="btn btn-danger" onclick="denyBoarding()">‚ùå Deny Boarding</button>
                                <button class="btn btn-secondary" onclick="clearScan()">üîÑ Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Boarding Statistics Area -->
            <div class="service-card">
                <div class="card-header">
                    <h3>üìä Boarding Statistics</h3>
                    <div class="status-indicator inactive" id="boarding-status-indicator"></div>
                </div>
                <div class="card-content">
                    <div class="flight-statistics" id="flight-statistics">
                        <div class="flight-header">
                            <div>
                                <h4 id="current-flight-display">Select a flight to view statistics</h4>
                                <div class="flight-subheader">
                                    <span id="current-gate-display"></span>
                                    <span id="current-departure-display"></span>
                                    <span id="current-status-display"></span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div id="flight-time-display"></div>
                                <div id="flight-date-display" style="color: #6b7280; font-size: 14px;"></div>
                            </div>
                        </div>
                        
                        <div class="boarding-progress" id="boarding-progress-section" style="display: none;">
                            <div class="passenger-counts">
                                <div class="count-item business">
                                    <span class="count-number" id="business-boarded">0</span>
                                    <span class="count-total">/ <span id="business-total">0</span></span>
                                    <span class="count-label">Business Class</span>
                                    <div class="count-percentage" id="business-percentage">0%</div>
                                </div>
                                <div class="count-item premium">
                                    <span class="count-number" id="premium-boarded">0</span>
                                    <span class="count-total">/ <span id="premium-total">0</span></span>
                                    <span class="count-label">Premium Economy</span>
                                    <div class="count-percentage" id="premium-percentage">0%</div>
                                </div>
                                <div class="count-item economy">
                                    <span class="count-number" id="economy-boarded">0</span>
                                    <span class="count-total">/ <span id="economy-total">0</span></span>
                                    <span class="count-label">Economy</span>
                                    <div class="count-percentage" id="economy-percentage">0%</div>
                                </div>
                            </div>
                            
                            <div class="overall-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="overall-progress-fill" style="width: 0%"></div>
                                    <span class="progress-text" id="overall-progress-text">0% Boarded</span>
                                </div>
                                <div class="progress-stats">
                                    <span id="total-boarded">0 boarded</span>
                                    <span id="total-passengers">0 total</span>
                                    <span id="total-checked-in">0 checked in</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="boarding-actions" id="boarding-actions" style="display: none;">
                            <button class="btn btn-success" onclick="startBoarding()">‚ñ∂Ô∏è Start Boarding</button>
                            <button class="btn btn-warning" onclick="holdBoarding()">‚è∏Ô∏è Hold Boarding</button>
                            <button class="btn btn-primary" onclick="finalizeBoarding()">‚úÖ Complete Boarding</button>
                            <button class="btn btn-secondary" onclick="notifyPilot()">üìû Notify Cockpit</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Boarding Records -->
            <div class="service-card">
                <div class="card-header">
                    <h3>üìã Recent Boarding Activity</h3>
                    <button class="btn btn-sm btn-secondary" onclick="refreshLogs()">üîÑ Refresh</button>
                </div>
                <div class="card-content">
                    <div class="boarding-log" id="boarding-log">
                        <div class="log-header">
                            <span>Time</span>
                            <span>Passenger</span>
                            <span>Seat</span>
                            <span>Class</span>
                            <span>Status</span>
                        </div>
                        <div class="log-entries" id="log-entries">
                            <div class="empty-state">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                                <h4 style="margin-bottom: 10px; color: #4b5563;">No Boarding Activity</h4>
                                <p style="color: #6b7280;">Select a flight to view boarding activity</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Global variables
        let currentFlight = null;
        let scannedPassenger = null;
        let boardingLogs = [];
        let flightDataCache = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Boarding page initialized');
            
            // Load initial flight data if available
            const flightSelect = document.getElementById('flight-select');
            if (flightSelect.value) {
                loadFlightData();
            }
        });

        // Load flight data
        async function loadFlightData() {
            const flightSelect = document.getElementById('flight-select');
            const flightCode = flightSelect.value;
            
            if (!flightCode) {
                resetFlightDisplay();
                return;
            }

            try {
                console.log('Loading flight data for:', flightCode);
                
                // First, get basic flight info from the dropdown
                const selectedOption = flightSelect.options[flightSelect.selectedIndex];
                const gate = selectedOption.getAttribute('data-gate');
                const departure = selectedOption.getAttribute('data-departure');
                const route = selectedOption.getAttribute('data-route');
                
                // Update display with basic info
                document.getElementById('current-flight-display').textContent = 
                    `${flightCode} - ${route}`;
                document.getElementById('current-gate-display').textContent = `Gate ${gate}`;
                document.getElementById('current-departure-display').textContent = `Departure: ${departure}`;
                
                // Try to fetch detailed flight data from API
                try {
                    const response = await fetch(`/api/flights/${flightCode}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        currentFlight = data.flight;
                        console.log('Flight data loaded:', currentFlight);
                        updateFlightDisplay();
                        updateBoardingStatistics();
                        loadBoardingLogs(flightCode);
                    } else {
                        // If API fails, use fallback data
                        useFallbackFlightData(flightCode, gate, departure, route);
                    }
                } catch (error) {
                    console.warn('API call failed, using fallback data:', error);
                    useFallbackFlightData(flightCode, gate, departure, route);
                }
                
            } catch (error) {
                console.error('Error loading flight data:', error);
                showNotification('Error loading flight data', 'error');
            }
        }

        // Use fallback flight data
        function useFallbackFlightData(flightCode, gate, departure, route) {
            currentFlight = {
                flight_code: flightCode,
                route_display: route,
                gate: gate,
                scheduled_departure: departure,
                flight_status: 'scheduled',
                total_seats: 180,
                total_checked_in: 0,
                total_booked: 0,
                business_seats: 20,
                premium_seats: 30,
                economy_seats: 130,
                business_booked: 0,
                premium_booked: 0,
                economy_booked: 0
            };
            
            updateFlightDisplay();
            updateBoardingStatistics();
            loadBoardingLogs(flightCode);
        }

        // Load gate data
        async function loadGateData() {
            const gate = document.getElementById('gate-select-boarding').value;
            if (!gate) return;

            try {
                const response = await fetch(`/api/flights/gate/${gate}`);
                const data = await response.json();
                
                if (data.success && data.flights.length > 0) {
                    const flight = data.flights[0];
                    const flightSelect = document.getElementById('flight-select');
                    
                    // Find and select the flight in dropdown
                    for (let i = 0; i < flightSelect.options.length; i++) {
                        if (flightSelect.options[i].value === flight.flight_code) {
                            flightSelect.selectedIndex = i;
                            break;
                        }
                    }
                    
                    loadFlightData();
                }
            } catch (error) {
                console.error('Error loading gate data:', error);
            }
        }

        // Reset flight display
        function resetFlightDisplay() {
            document.getElementById('current-flight-display').textContent = 'Select a flight to view statistics';
            document.getElementById('current-gate-display').textContent = '';
            document.getElementById('current-departure-display').textContent = '';
            document.getElementById('current-status-display').textContent = '';
            document.getElementById('boarding-progress-section').style.display = 'none';
            document.getElementById('boarding-actions').style.display = 'none';
            
            // Clear boarding logs
            const container = document.getElementById('log-entries');
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                    <h4 style="margin-bottom: 10px; color: #4b5563;">No Boarding Activity</h4>
                    <p style="color: #6b7280;">Select a flight to view boarding activity</p>
                </div>
            `;
        }

        // Update flight display
        function updateFlightDisplay() {
            if (!currentFlight) return;

            document.getElementById('current-flight-display').textContent = 
                `${currentFlight.flight_code} - ${currentFlight.route_display}`;
            document.getElementById('current-gate-display').textContent = `Gate ${currentFlight.gate}`;
            document.getElementById('current-departure-display').textContent = `Departure: ${currentFlight.scheduled_departure}`;
            document.getElementById('current-status-display').textContent = `Status: ${currentFlight.flight_status}`;
            
            document.getElementById('boarding-progress-section').style.display = 'block';
            document.getElementById('boarding-actions').style.display = 'flex';
            
            // Update boarding status indicator
            const indicator = document.getElementById('boarding-status-indicator');
            if (currentFlight.flight_status === 'boarding') {
                indicator.className = 'status-indicator active';
            } else if (currentFlight.flight_status === 'delayed') {
                indicator.className = 'status-indicator warning';
            } else if (currentFlight.flight_status === 'departed') {
                indicator.className = 'status-indicator error';
            } else {
                indicator.className = 'status-indicator inactive';
            }
        }

        // Update boarding statistics
        function updateBoardingStatistics() {
            if (!currentFlight) return;

            console.log('Updating statistics with flight:', currentFlight);

            // Use actual flight data or fallback
            const businessTotal = currentFlight.business_seats || 20;
            const premiumTotal = currentFlight.premium_seats || 30;
            const economyTotal = currentFlight.economy_seats || 130;
            
            // For boarded counts, we should use actual boarding data
            // For now, use booked counts as placeholder
            const businessBoarded = currentFlight.business_booked || 0;
            const premiumBoarded = currentFlight.premium_booked || 0;
            const economyBoarded = currentFlight.economy_booked || 0;
            
            const totalCheckedIn = currentFlight.total_checked_in || 0;
            const totalBooked = currentFlight.total_booked || 0;
            const totalSeats = currentFlight.total_seats || 180;

            // Update displays
            document.getElementById('business-total').textContent = businessTotal;
            document.getElementById('premium-total').textContent = premiumTotal;
            document.getElementById('economy-total').textContent = economyTotal;
            
            document.getElementById('business-boarded').textContent = businessBoarded;
            document.getElementById('premium-boarded').textContent = premiumBoarded;
            document.getElementById('economy-boarded').textContent = economyBoarded;

            // Calculate percentages
            const businessPercentage = businessTotal > 0 ? Math.round((businessBoarded / businessTotal) * 100) : 0;
            const premiumPercentage = premiumTotal > 0 ? Math.round((premiumBoarded / premiumTotal) * 100) : 0;
            const economyPercentage = economyTotal > 0 ? Math.round((economyBoarded / economyTotal) * 100) : 0;

            document.getElementById('business-percentage').textContent = `${businessPercentage}%`;
            document.getElementById('premium-percentage').textContent = `${premiumPercentage}%`;
            document.getElementById('economy-percentage').textContent = `${economyPercentage}%`;

            // Overall progress
            const totalBoarded = businessBoarded + premiumBoarded + economyBoarded;
            const overallPercentage = totalSeats > 0 ? Math.round((totalBoarded / totalSeats) * 100) : 0;

            document.getElementById('overall-progress-fill').style.width = `${overallPercentage}%`;
            document.getElementById('overall-progress-text').textContent = `${overallPercentage}% Boarded`;
            document.getElementById('total-boarded').textContent = `${totalBoarded} boarded`;
            document.getElementById('total-passengers').textContent = `${totalSeats} total`;
            document.getElementById('total-checked-in').textContent = `${totalCheckedIn} checked in`;
        }

        // Scan boarding pass
        async function scanBoardingPass() {
            const input = document.getElementById('boarding-pass-input').value.trim();
            if (!input) {
                showNotification('Please enter a boarding pass ID', 'error');
                return;
            }

            try {
                // Show loading
                const scannerStatus = document.getElementById('scanner-status');
                scannerStatus.style.background = '#f59e0b';
                
                // Try different formats
                let boardingPassData = null;
                
                // Try API first
                try {
                    const response = await fetch(`/api/boarding-pass/${input}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        boardingPassData = data.boardingPass;
                    }
                } catch (apiError) {
                    console.warn('API call failed, using mock data:', apiError);
                }
                
                // If no data from API, use mock data
                if (!boardingPassData) {
                    boardingPassData = getMockBoardingPass(input);
                }
                
                if (boardingPassData) {
                    scannedPassenger = boardingPassData;
                    displayScanResult(scannedPassenger);
                    scannerStatus.style.background = '#10b981';
                } else {
                    showNotification('Boarding pass not found', 'error');
                    scannerStatus.style.background = '#ef4444';
                }
            } catch (error) {
                console.error('Error scanning boarding pass:', error);
                showNotification('Error scanning boarding pass', 'error');
                document.getElementById('scanner-status').style.background = '#ef4444';
            }
        }

        // Get mock boarding pass (for testing)
        function getMockBoardingPass(input) {
            const mockPasses = {
                'BP-BK-ALA-001': {
                    boarding_pass_id: 'BP-BK-ALA-001',
                    passenger_name: 'Alan Wong',
                    seat_number: '24A',
                    cabin_class: 'Premium',
                    flight_code: 'HX101',
                    status: 'issued',
                    passport_number: 'A12345678'
                },
                'BARCODE-1764684722934-1': {
                    boarding_pass_id: 'BARCODE-1764684722934-1',
                    passenger_name: 'Alan Wong',
                    seat_number: '24A',
                    cabin_class: 'Premium',
                    flight_code: 'HX101',
                    status: 'issued',
                    passport_number: 'A12345678'
                }
            };
            
            return mockPasses[input] || {
                boarding_pass_id: input,
                passenger_name: 'Test Passenger',
                seat_number: '12B',
                cabin_class: 'Economy',
                flight_code: 'TEST101',
                status: 'issued',
                passport_number: 'TEST123456'
            };
        }

        // Display scan result
        function displayScanResult(passenger) {
            document.getElementById('scanned-name').textContent = passenger.passenger_name || 'Unknown';
            document.getElementById('scanned-seat').textContent = passenger.seat_number || '-';
            document.getElementById('scanned-class').textContent = passenger.cabin_class || '-';
            document.getElementById('scanned-flight').textContent = passenger.flight_code || '-';
            document.getElementById('scanned-status').textContent = passenger.status || '-';
            document.getElementById('scanned-passport').textContent = passenger.passport_number || '-';
            document.getElementById('scan-result').style.display = 'block';
            
            // Focus on confirm button
            setTimeout(() => {
                const confirmBtn = document.querySelector('.btn-success');
                if (confirmBtn) confirmBtn.focus();
            }, 100);
        }

        // Confirm boarding
        async function confirmBoarding() {
            if (!scannedPassenger) {
                showNotification('No passenger selected', 'error');
                return;
            }

            try {
                // Check if passenger belongs to current flight
                if (currentFlight && scannedPassenger.flight_code !== currentFlight.flight_code) {
                    if (!confirm(`This passenger is on flight ${scannedPassenger.flight_code}, not ${currentFlight.flight_code}. Continue anyway?`)) {
                        return;
                    }
                }

                // Show loading
                const originalText = event.target.innerHTML;
                event.target.disabled = true;
                event.target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                // Try API first
                let success = false;
                try {
                    const response = await fetch('/api/boarding/confirm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            boarding_pass_id: scannedPassenger.boarding_pass_id,
                            passenger_id: scannedPassenger.passenger_id || 'TEST123'
                        })
                    });

                    const data = await response.json();
                    success = data.success;
                } catch (apiError) {
                    console.warn('API call failed, simulating boarding:', apiError);
                    success = true; // Simulate success for demo
                }

                // Reset button
                event.target.disabled = false;
                event.target.innerHTML = originalText;

                if (success) {
                    showNotification(`Boarding confirmed for ${scannedPassenger.passenger_name}`, 'success');
                    
                    // Add to boarding logs
                    addToBoardingLog({
                        passenger_name: scannedPassenger.passenger_name,
                        seat_number: scannedPassenger.seat_number,
                        cabin_class: scannedPassenger.cabin_class,
                        boarding_status: 'boarded',
                        boarding_time: new Date()
                    });
                    
                    // Update statistics
                    if (currentFlight) {
                        updateBoardingStatisticsAfterBoarding(scannedPassenger.cabin_class);
                    }
                    
                    clearScan();
                } else {
                    showNotification('Error confirming boarding', 'error');
                }
            } catch (error) {
                console.error('Error confirming boarding:', error);
                showNotification('Error confirming boarding', 'error');
            }
        }

        // Update statistics after boarding
        function updateBoardingStatisticsAfterBoarding(cabinClass) {
            if (!currentFlight) return;
            
            // Update the appropriate count
            const countId = cabinClass.toLowerCase().includes('business') ? 'business-boarded' :
                           cabinClass.toLowerCase().includes('premium') ? 'premium-boarded' : 'economy-boarded';
            
            const countElement = document.getElementById(countId);
            const currentCount = parseInt(countElement.textContent) || 0;
            countElement.textContent = currentCount + 1;
            
            // Recalculate percentages
            updateBoardingStatistics();
        }

        // Add to boarding log
        function addToBoardingLog(logEntry) {
            // Add to beginning of array
            boardingLogs.unshift(logEntry);
            
            // Update display
            updateBoardingLogsDisplay();
        }

        // Update boarding logs display
        function updateBoardingLogsDisplay() {
            const container = document.getElementById('log-entries');
            
            if (boardingLogs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                        <h4 style="margin-bottom: 10px; color: #4b5563;">No Boarding Activity</h4>
                        <p style="color: #6b7280;">Scan boarding passes to see activity</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = boardingLogs.map(log => `
                <div class="log-entry">
                    <span>${formatTime(log.boarding_time)}</span>
                    <span>${log.passenger_name || 'Unknown'}</span>
                    <span>${log.seat_number || '-'}</span>
                    <span>${log.cabin_class || '-'}</span>
                    <span class="status ${log.boarding_status}">${log.boarding_status}</span>
                </div>
            `).join('');
        }

        // Deny boarding
        async function denyBoarding() {
            if (!scannedPassenger) {
                showNotification('No passenger selected', 'error');
                return;
            }

            if (!confirm(`Deny boarding for ${scannedPassenger.passenger_name}?`)) {
                return;
            }

            try {
                // Try API first
                let success = false;
                try {
                    const response = await fetch('/api/boarding/deny', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            boarding_pass_id: scannedPassenger.boarding_pass_id,
                            passenger_id: scannedPassenger.passenger_id || 'TEST123',
                            reason: prompt('Enter reason for denial:') || 'Not specified'
                        })
                    });

                    const data = await response.json();
                    success = data.success;
                } catch (apiError) {
                    console.warn('API call failed, simulating denial:', apiError);
                    success = true; // Simulate success for demo
                }

                if (success) {
                    showNotification(`Boarding denied for ${scannedPassenger.passenger_name}`, 'warning');
                    
                    // Add to boarding logs
                    addToBoardingLog({
                        passenger_name: scannedPassenger.passenger_name,
                        seat_number: scannedPassenger.seat_number,
                        cabin_class: scannedPassenger.cabin_class,
                        boarding_status: 'denied',
                        boarding_time: new Date()
                    });
                    
                    clearScan();
                } else {
                    showNotification('Error denying boarding', 'error');
                }
            } catch (error) {
                console.error('Error denying boarding:', error);
                showNotification('Error denying boarding', 'error');
            }
        }

        // Clear scan
        function clearScan() {
            document.getElementById('boarding-pass-input').value = '';
            document.getElementById('scan-result').style.display = 'none';
            document.getElementById('scanner-status').style.background = '#6b7280';
            scannedPassenger = null;
            
            // Focus back on input
            document.getElementById('boarding-pass-input').focus();
        }

        // Load boarding logs
        async function loadBoardingLogs(flightCode) {
            try {
                const response = await fetch(`/api/boarding-logs/${flightCode}`);
                const data = await response.json();
                
                if (data.success) {
                    boardingLogs = data.logs || [];
                    updateBoardingLogsDisplay();
                }
            } catch (error) {
                console.error('Error loading boarding logs:', error);
                // Use mock data for demo
                boardingLogs = getMockBoardingLogs(flightCode);
                updateBoardingLogsDisplay();
            }
        }

        // Get mock boarding logs
        function getMockBoardingLogs(flightCode) {
            return [
                {
                    passenger_name: 'Alan Wong',
                    seat_number: '24A',
                    cabin_class: 'Premium',
                    boarding_status: 'boarded',
                    boarding_time: new Date(Date.now() - 3600000) // 1 hour ago
                },
                {
                    passenger_name: 'Lisa Chen',
                    seat_number: '15B',
                    cabin_class: 'Business',
                    boarding_status: 'boarded',
                    boarding_time: new Date(Date.now() - 7200000) // 2 hours ago
                },
                {
                    passenger_name: 'David Lee',
                    seat_number: '32C',
                    cabin_class: 'Economy',
                    boarding_status: 'checked_in',
                    boarding_time: new Date(Date.now() - 10800000) // 3 hours ago
                }
            ];
        }

        // Boarding actions
        async function startBoarding() {
            if (!currentFlight) return;
            
            try {
                // Update flight status
                if (currentFlight.flight_status !== 'boarding') {
                    currentFlight.flight_status = 'boarding';
                    showNotification('Boarding started', 'success');
                    document.getElementById('boarding-status-indicator').className = 'status-indicator active';
                    document.getElementById('current-status-display').textContent = 'Status: boarding';
                }
            } catch (error) {
                console.error('Error starting boarding:', error);
            }
        }

        async function holdBoarding() {
            if (!currentFlight) return;
            
            try {
                // Update flight status
                if (currentFlight.flight_status !== 'delayed') {
                    currentFlight.flight_status = 'delayed';
                    showNotification('Boarding held', 'warning');
                    document.getElementById('boarding-status-indicator').className = 'status-indicator warning';
                    document.getElementById('current-status-display').textContent = 'Status: delayed';
                }
            } catch (error) {
                console.error('Error holding boarding:', error);
            }
        }

        async function finalizeBoarding() {
            if (!currentFlight) return;
            
            if (!confirm('Finalize boarding and close the gate?')) return;

            try {
                // Update flight status
                if (currentFlight.flight_status !== 'departed') {
                    currentFlight.flight_status = 'departed';
                    showNotification('Boarding finalized', 'success');
                    document.getElementById('boarding-status-indicator').className = 'status-indicator error';
                    document.getElementById('current-status-display').textContent = 'Status: departed';
                }
            } catch (error) {
                console.error('Error finalizing boarding:', error);
            }
        }

        function notifyPilot() {
            showNotification('Cockpit notified - Ready for departure', 'info');
        }

        function refreshLogs() {
            if (currentFlight) {
                loadBoardingLogs(currentFlight.flight_code);
            }
            showNotification('Logs refreshed', 'info');
        }

        // Helper functions
        function formatTime(date) {
            if (!date) return '-';
            try {
                const dateObj = new Date(date);
                return dateObj.toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            } catch (error) {
                return '-';
            }
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.custom-notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1001;
                padding: 15px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                min-width: 300px;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            
            // Set color
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            notification.style.background = colors[type] || colors.info;
            notification.style.borderLeft = `4px solid ${colors[type] || colors.info}`;
            
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; margin-left: 15px;">√ó</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Add CSS for slideIn animation
        if (!document.querySelector('#notification-animation')) {
            const style = document.createElement('style');
            style.id = 'notification-animation';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize event listeners
        document.getElementById('boarding-pass-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scanBoardingPass();
            }
        });

        // Export functions to window
        window.loadFlightData = loadFlightData;
        window.loadGateData = loadGateData;
        window.scanBoardingPass = scanBoardingPass;
        window.confirmBoarding = confirmBoarding;
        window.denyBoarding = denyBoarding;
        window.clearScan = clearScan;
        window.startBoarding = startBoarding;
        window.holdBoarding = holdBoarding;
        window.finalizeBoarding = finalizeBoarding;
        window.notifyPilot = notifyPilot;
        window.refreshLogs = refreshLogs;
        window.showNotification = showNotification;
    </script>
</body>
</html>